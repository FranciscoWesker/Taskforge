services:
  - type: web
    name: taskforge-backend
    env: node
    plan: free
    rootDir: backend
    healthCheckPath: /health
    buildCommand: NPM_CONFIG_PRODUCTION=false npm install && npm run build
    startCommand: node dist/server.js
    autoDeploy: true
    envVars:
      - key: CLIENT_ORIGIN
        value: https://taskforge-21m4.onrender.com
      - key: BACKEND_URL
        value: https://taskforge-ufzf.onrender.com
      - key: MONGODB_URI
        sync: false
      # IMPORTANTE: USE_MEM_MONGO debe ser "false" en producción
      # MongoDB en memoria se pierde al reiniciar el servidor (cada 15 min en Render free tier)
      # Configure MONGODB_URI con una URI de MongoDB Atlas o MongoDB real
      # - key: USE_MEM_MONGO
      #   value: "false"
  - type: static_site
    name: taskforge-frontend
    plan: free
    rootDir: frontend
    buildCommand: npm install && npm run build
    staticPublishPath: dist/taskforge-ui/browser
    headers:
      - path: /*
        name: Content-Security-Policy
        value: >-
          default-src 'self';
          base-uri 'self';
          object-src 'none';
          img-src 'self' data: https:;
          font-src 'self' https:;
          script-src 'self' https://*.firebaseapp.com https://*.googleapis.com;
          style-src 'self' 'unsafe-inline';
          connect-src 'self' https://*.onrender.com wss://*.onrender.com https://*.firebaseapp.com https://*.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com;
          frame-ancestors 'self';
    # Redirecciones para SPA (Single Page Application)
    # Render automáticamente excluye archivos estáticos del catch-all
    # Una sola regla catch-all es suficiente: todas las rutas van a index.html
    # Status 200 permite que Angular maneje el routing del lado del cliente
    redirects:
      - source: /*
        destination: /index.html
        status: 200

